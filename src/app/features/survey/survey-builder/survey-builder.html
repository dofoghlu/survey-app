<div class="h-full flex flex-col">
  <div
    class="flex items-center justify-between py-2 bg-white sticky top-0 z-10 border-gray-200 mb-4"
  >
    <div class="flex items-center gap-3">
      <button class="text-button flex items-center gap-1" (click)="onBack()">
        <lucide-icon [img]="ArrowLeft" class="w-4 h-4"></lucide-icon> Back
      </button>

      @if (hasUnsavedChanges) {
        <span class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-700">
          Unsaved changes
        </span>
      }
    </div>

    <div class="flex items-center gap-4">
      <app-switch label="Preview" [checked]="showPreview" (valueChange)="showPreview = $event" />

      <button class="button-primary" [disabled]="isSaving" (click)="onSave()">
        @if (isSaving) {
          <span class="spinner"></span>
        }
        Save
      </button>
    </div>
  </div>

  @if (isLoading) {
    <div class="flex-1 flex items-center justify-center">
      <div
        class="h-8 w-8 rounded-full border-2 border-gray-300 border-t-blue-600 animate-spin"
        aria-label="Loading survey"
      ></div>
    </div>
  } @else {
    <div class="flex gap-6">
      <div
        class="flex-1 px-10 pt-6 pb-8 flex flex-col gap-6 border-default"
        [formGroup]="surveyForm"
      >
        <div>
          <input
            class="text-3xl font-semibold w-full"
            [formControl]="title"
            placeholder="Survey Title"
            aria-label="Survey Title"
          />
          <input
            class="w-full text-lg"
            [formControl]="description"
            placeholder="Survey Description"
            aria-label="Survey Description"
          />
        </div>
        @for (q of questions.controls; let i = $index; track i) {
          <app-question-editor
            [index]="i"
            [questionForm]="q"
            (remove)="removeQuestion(i)"
            (moveUp)="moveQuestionUp(i)"
            (moveDown)="moveQuestionDown(i)"
          ></app-question-editor>
        }
        <button class="self-start text-button flex items-center gap-1" (click)="addQuestion()">
          <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon> Add a question
        </button>
      </div>

      @if (showPreview) {
        <div class="w-[380px] shrink-0 border-default p-4 overflow-y-auto">
          <app-survey-preview [form]="surveyForm"></app-survey-preview>
        </div>
      }
    </div>
  }
</div>

<app-dialog
  [open]="showUnsavedDialog"
  title="Unsaved changes"
  confirmLabel="Leave"
  [destructive]="true"
  (confirm)="dialogConfirm.emit()"
  (cancel)="dialogCancel.emit()"
>
  <p>You have made changes to this survey that have not been saved.</p>
  <p>Are you sure you want to leave without saving?</p>
</app-dialog>
